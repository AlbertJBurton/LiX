% AUTHOR: Nicklas Vraa
%
% Provides context-aware commands for in-document elements, like headings,
% table of contents, inline formatting, math equations, code blocks, tables,
% figures, etc.
% ------------------------------------------------------------------------------

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{elements}

\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage[nottoc]{tocbibind}
\RequirePackage{amsfonts, amsmath, amssymb, caption, cite, enumitem, esint, fancyhdr, float, graphicx, hyperref, listings, microtype, siunitx, svg, ulem, tabularray, xcolor, xparse}

% TABLE OF CONTENTS: -----------------------------------------------------------

    \newcommand{\toc}{\tableofcontents}

    \@ifundefined{chapter}{}{% If class is article-like.
        \addtocontents{toc}{\protect\thispagestyle{empty}}
    }

% FORMATTING: ------------------------------------------------------------------

    \normalem % Allow italized and underlined text.

    \renewcommand{\b}[1]{\textbf{#1}} % Bold.
    \renewcommand{\i}[1]{\textit{#1}} % Italic.
    \renewcommand{\u}[1]{\uline{#1}}  % Underline.
    \newcommand{\s}[1]{\sout{#1}}     % Strikethrough.

% IMPORTING: -------------------------------------------------------------------

    \newcommand{\add}[1]{\input{#1}}

% HEADINGS: --------------------------------------------------------------------

    \@ifundefined{chapter}{% If class is article-like.
        \NewDocumentCommand{\h}{sm}{%
            \IfBooleanTF{#1}{%
                \section*{#2}\label{#2}%
                \addcontentsline{toc}{section}{#2}%
            }{%
                \section{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsection}{#2}%
            }{%
                \subsection{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsubsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsubsection}{#2}%
            }{%
                \subsubsection{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhhh}{sm}{%
            \IfBooleanTF{#1}{%
                \paragraph*{#2}
            }{%
                \paragraph{#2}
            }
        }
    }{% If class is book-like.
        \NewDocumentCommand{\h}{sm}{%
            \IfBooleanTF{#1}{%
                \chapter*{#2}\label{#2}%
                \addcontentsline{toc}{chapter}{#2}%
            }{%
                \chapter{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hh}{sm}{%
            \IfBooleanTF{#1}{%
                \section*{#2}\label{#2}%
                \addcontentsline{toc}{section}{#2}%
            }{%
                \section{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsection}{#2}%
            }{%
                \subsection{#2}\label{#2}%
            }
        }
        \NewDocumentCommand{\hhhh}{sm}{%
            \IfBooleanTF{#1}{%
                \subsubsection*{#2}\label{#2}%
                \addcontentsline{toc}{subsubsection}{#2}%
            }{%
                \subsubsection{#2}\label{#2}%
            }
        }
    }

% MATHEMATICS: -----------------------------------------------------------------

    \newcommand{\mean}[1]{\overline{#1}}
    \renewcommand{\epsilon}{\varepsilon}
    \renewcommand{\Re}{\mathbb{R}} % Real set.
    \renewcommand{\Im}{\mathbb{I}} % Imaginary set.
    \newcommand{\N}{\mathbb{N}} % Natural set.
    \newcommand{\Z}{\mathbb{Z}} % Integer set.
    \newcommand{\Q}{\mathbb{Q}} % Rational set.
    \newcommand{\C}{\mathbb{C}} % Complex set.

    \newcommand{\m}[1]{$#1$} % Inline math.

    \RenewDocumentCommand{\math}{mm}{% Block of math.
        \begin{equation}\label{#1}
            #2
        \end{equation}
    }

% CODE: ------------------------------------------------------------------------

    \lstdefinestyle{inline}{% Inline styling.
        basicstyle=\ttfamily\small, breaklines=true%
    }

    \lstdefinestyle{block}{% Block styling.
        basicstyle=\ttfamily\footnotesize,
        commentstyle=\color[rgb]{0.5,0.5,0.5},
        breaklines=true,
        numbers=left,
        numberstyle=\tiny,
        numbersep=7pt,
        showstringspaces=false,
        xleftmargin=14pt,
        postbreak=\mbox{\hspace{-2.5em}\textcolor{gray}{$\hookrightarrow$}\space\space}
    }

    \RenewDocumentCommand{\c}{v}{%
        \lstinline[style=inline]{#1}%
    }

    \ExplSyntaxOn
    \NewDocumentCommand{\code}{mmm +v}{
        \begingroup
        \begin{center}\noindent\rule{\columnwidth}{0.1pt}\end{center}%
        \vspace*{-1mm}%
        \newlinechar=\endlinechar
        \exp_args:Nx \scantokens{
            \string\begin{lstlisting}[\unexpanded{language=#2,style=block}]
            #4
            \string\end{lstlisting}
        }
        \vspace*{-5mm}%
        \begin{center}\noindent\rule{\columnwidth}{0.1pt}\end{center}%
        \captionsetup{type=lstlisting}%
        \caption{#3}%
        \label{#1}%
        \vspace*{0.8em}%
        \endgroup
    }
    \ExplSyntaxOff

    % Add reference category for code blocks.
    \renewcommand{\lstlistingname}{Snippet}
    \providecommand*{\lstlistingautorefname}{snippet}

% TABLES: ----------------------------------------------------------------------

    \NewDocumentCommand{\tabs}{mmmm}{
        \begin{table}[h!]
            \centering
            \ifnum\pdfstrcmp{#2}{cols}=0
                \sbox0{%
                    \begin{tblr}{%
                        hline{1,2,Z} = {0.1pt,solid},
                        rowsep = {1pt}, hspan = even}%
                        #4
                    \end{tblr}%
                }
            \else\ifnum\pdfstrcmp{#2}{rows}=0
                \sbox0{%
                    \begin{tblr}{%
                        hline{1,Z} = {0.1pt,solid},
                        vline{2} = {0.1pt,solid},
                        rowsep = {1pt}, hspan = even}%
                        #4
                    \end{tblr}%
                }
            \else\ifnum\pdfstrcmp{#2}{grid}=0
                \sbox0{%
                    \begin{tblr}{%
                        hline{1,2,Z} = {0.1pt,solid},
                        vline{2} = {0.1pt,solid},
                        rowsep = {1pt}, hspan = even}%
                        #4
                    \end{tblr}%
                }
            \else
                \sbox0{%
                    \begin{tblr}{#2}%
                        #4
                    \end{tblr}%
                }
            \fi\fi\fi
            \begin{minipage}{\wd0}
                \usebox0\caption{#3}\label{#1}
            \end{minipage}
        \end{table}
    }

% FIGURES: ---------------------------------------------------------------------

    \def\maxwidth#1{\ifdim\Gin@nat@width>#1 #1\else\Gin@nat@width\fi}

    \NewDocumentCommand{\fig}{mmmG{1}}{ % One command for vectors and images.
        \begin{figure}[h!]
            \centering
            \filename@parse{#3}
            \ifnum\pdfstrcmp{\filename@ext}{svg}=0%
                \sbox0{\includesvg[width=#4\columnwidth]{#3}}%
            \else%
                \sbox0{\includegraphics[width=\maxwidth{#4\columnwidth}]{#3}}%
            \fi%
            \begin{minipage}{\wd0}\usebox0\caption{#2}\label{#1}\end{minipage}
        \end{figure}
    }

% LINKING: ---------------------------------------------------------------------

    \hypersetup{hidelinks} % Remove box around links.
    \renewcommand{\url}[2]{\href{#2}{#1}}

    % Lowercase reference names.
    \renewcommand{\r}[1]{\renewcommand\lstlistingautorefname{snippet}\renewcommand\figureautorefname{figure}\renewcommand\equationautorefname{equation}\renewcommand\tableautorefname{table}\renewcommand\sectionautorefname{section}\renewcommand\subsectionautorefname{section}\renewcommand\subsubsectionautorefname{section}\renewcommand\paragraphautorefname{section}\renewcommand\subparagraphautorefname{section}\autoref{#1}}

    % Uppercase reference names.
    \newcommand{\R}[1]{\renewcommand\lstlistingautorefname{Snippet}\renewcommand\figureautorefname{Figure}\renewcommand\equationautorefname{Equation}\renewcommand\tableautorefname{Table}\renewcommand\sectionautorefname{Section}\renewcommand\subsectionautorefname{Section}\renewcommand\subsubsectionautorefname{Section}\renewcommand\paragraphautorefname{Section}\renewcommand\subparagraphautorefname{Section}\autoref{#1}}

    \newcommand{\bib}[1]{\bibliography{#1}}
