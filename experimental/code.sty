% AUTHOR: Nicklas Vraa
% A collection of packages, commands, and settings for including
% source code in a document.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{code}

\RequirePackage{caption, inconsolata, listings, xcolor, xparse}

\lstdefinestyle{inline}{% Inline styling.
    basicstyle=\ttfamily\small, breaklines=true%
}

\lstdefinestyle{block}{% Block styling.
    basicstyle=\ttfamily\footnotesize,
    commentstyle=\color[rgb]{0.5,0.5,0.5},
    breaklines=true,
    numbers=left,
    numberstyle=\tiny,
    numbersep=7pt,
    showstringspaces=false,
    xleftmargin=14pt,
    postbreak=\mbox{\hspace{-2.5em}\textcolor{gray}{$\hookrightarrow$}\space\space}
}

\RenewDocumentCommand{\c}{v}{%
    \lstinline[style=inline]{#1}%
}

\ExplSyntaxOn
    \NewDocumentCommand{\code}{mmm +v}{%
        \begingroup%
            \noindent\rule{\columnwidth}{0.1pt}%
            \vspace*{-1mm}%
            \newlinechar=\endlinechar
            \exp_args:Nx \scantokens{
                \string\begin{lstlisting}[\unexpanded{language=#2,style=block}]
                #4
                \string\end{lstlisting}
            }
            \vspace*{-2mm}%
            \noindent\rule{\columnwidth}{0.1pt}
            \captionsetup{type=lstlisting}%
            \caption{#3}%
            \label{#1}%
            \vspace*{0.8em}%
        \endgroup%
    }
\ExplSyntaxOff

% Add reference category for code blocks.
\renewcommand{\lstlistingname}{Snippet}
\providecommand*{\lstlistingautorefname}{snippet}
